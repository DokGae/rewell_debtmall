<div>
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold"><%= @business.name %> 상품 관리</h1>
      <p class="text-zinc-500 mt-1">총 <%= @products.total_count %>개 상품</p>
    </div>
    <div class="flex gap-2">
      <%= link_to "업체 정보", admin_business_path(@business), class: "btn-secondary" %>
      <%= link_to "새 상품 등록", new_admin_business_product_path(@business), class: "btn-primary" %>
    </div>
  </div>

  <!-- 상품 필터 -->
  <div class="bg-zinc-900 rounded-lg p-4 mb-6 border border-zinc-800">
    <%= form_with url: admin_business_products_path(@business), method: :get, local: true do |f| %>
      <div class="flex flex-wrap gap-4 items-center">
        <!-- 카테고리 필터 -->
        <div class="flex items-center gap-2">
          <label class="text-sm text-zinc-400">카테고리:</label>
          <% root_categories = @categories.select { |c| c.parent_id.nil? }.sort_by { |c| [c.position || 0, c.name] } %>
          <%= f.select :category_id,
              options_for_select(
                [["모든 카테고리", ""]] + hierarchical_category_options(root_categories),
                params[:category_id]
              ),
              {},
              class: "bg-zinc-800 text-white px-3 py-1.5 rounded-lg border border-zinc-700 focus:outline-none focus:border-blue-500 min-w-[200px]",
              onchange: "this.form.submit()" %>
        </div>
        
        <!-- 상태 필터 -->
        <div class="flex items-center gap-2">
          <label class="text-sm text-zinc-400">상태:</label>
          <%= f.select :status,
              options_for_select([["모든 상태", ""]] + Product.status_options, params[:status]),
              {},
              class: "bg-zinc-800 text-white px-3 py-1.5 rounded-lg border border-zinc-700 focus:outline-none focus:border-blue-500",
              onchange: "this.form.submit()" %>
        </div>
        
        <!-- 재고 필터 -->
        <label class="flex items-center gap-2 cursor-pointer">
          <%= f.check_box :in_stock, 
              { checked: params[:in_stock].present?, class: "w-4 h-4 text-blue-600 bg-zinc-800 border-zinc-600 rounded focus:ring-blue-500", onchange: "this.form.submit()" }, 
              "1", nil %>
          <span class="text-sm text-zinc-300">재고 있는 상품만 표시</span>
        </label>
        
        <!-- 필터 초기화 -->
        <% if params[:category_id] || params[:status] || params[:in_stock] %>
          <%= link_to "필터 초기화", admin_business_products_path(@business), 
              class: "text-sm text-zinc-400 hover:text-white ml-auto" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="card overflow-hidden">
    <table class="w-full">
      <thead class="border-b border-zinc-800">
        <tr>
          <th class="text-left p-4">상품명</th>
          <th class="text-left p-4">카테고리</th>
          <th class="text-left p-4">가격</th>
          <th class="text-left p-4">제안 갯수</th>
          <th class="text-left p-4">최고 제안가</th>
          <th class="text-left p-4">재고</th>
          <th class="text-left p-4">상태</th>
          <th class="text-left p-4">작업</th>
        </tr>
      </thead>
      <tbody>
        <% @products.each do |product| %>
          <tr class="border-b border-zinc-800 hover:bg-zinc-900">
            <td class="p-4">
              <div class="flex items-center gap-3">
                <% if product.images.attached? %>
                  <%= image_tag product.images.first.variant(:thumb), 
                      class: "w-12 h-12 rounded object-cover" %>
                <% else %>
                  <div class="w-12 h-12 rounded bg-zinc-800 flex items-center justify-center">
                    <span class="text-zinc-600 text-xs">이미지 없음</span>
                  </div>
                <% end %>
                <div>
                  <p class="font-semibold"><%= product.name %></p>
                  <% if product.featured? %>
                    <span class="text-xs text-yellow-500">★ 추천</span>
                  <% end %>
                </div>
              </div>
            </td>
            <td class="p-4">
              <% if product.category %>
                <span class="text-sm px-2 py-1 bg-zinc-800 rounded">
                  <%= product.category.name %>
                </span>
              <% else %>
                <span class="text-zinc-500 text-sm">미지정</span>
              <% end %>
            </td>
            <td class="p-4">
              <% if product.discount_percentage > 0 %>
                <p class="text-red-500 text-sm">
                  <%= product.discount_percentage %>% 할인
                </p>
                <p class="text-zinc-500 line-through text-sm">
                  <%= format_currency(product.original_price) %>
                </p>
              <% end %>
              <p class="font-semibold">
                <%= format_currency(product.sale_price) %>
              </p>
            </td>
            <td class="p-4 text-center">
              <% if product.has_offers? %>
                <%= link_to product.offer_count, admin_purchase_requests_path(product_id: product.id), 
                    class: "text-sm font-semibold text-orange-400 hover:text-orange-300 hover:underline" %>
              <% else %>
                <span class="text-zinc-500">0</span>
              <% end %>
            </td>
            <td class="p-4">
              <% if product.has_offers? %>
                <span class="font-semibold text-green-400">
                  <%= format_currency(product.max_offer_price) %>
                </span>
              <% else %>
                <span class="text-zinc-500">-</span>
              <% end %>
            </td>
            <td class="p-4">
              <% if product.stock_quantity.present? %>
                <span class="<%= product.in_stock? ? '' : 'text-red-500' %>">
                  <%= product.stock_quantity %>개
                </span>
              <% else %>
                <span class="text-zinc-500">-</span>
              <% end %>
            </td>
            <td class="p-4">
              <span class="text-sm <%= product.available? ? 'text-green-500' : 'text-zinc-500' %>">
                <%= product.status_text %>
              </span>
            </td>
            <td class="p-4">
              <div class="flex gap-2 flex-wrap">
                <%= link_to "보기", admin_business_product_path(@business, product), 
                    class: "text-sm text-zinc-400 hover:text-white" %>
                <%= link_to "수정", edit_admin_business_product_path(@business, product), 
                    class: "text-sm text-zinc-400 hover:text-white" %>
                <%= link_to "삭제", admin_business_product_path(@business, product), 
                    method: :delete,
                    data: { turbo_method: :delete, turbo_confirm: "정말 삭제하시겠습니까?" },
                    class: "text-sm text-red-500 hover:text-red-400" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <% if @products.empty? %>
      <div class="text-center py-8">
        <p class="text-zinc-500">등록된 상품이 없습니다.</p>
      </div>
    <% end %>
  </div>
  
  <div class="mt-6 flex justify-center">
    <%= paginate @products %>
  </div>
</div>