<% content_for :title, "상품 관리" %>

<div class="mb-8 flex justify-between items-center">
  <div>
    <h1 class="text-3xl font-bold">상품 관리</h1>
    <p class="text-zinc-400 mt-2">업체의 상품을 관리하세요</p>
  </div>
  
  <%= link_to "새 상품 등록", new_business_product_path, class: "btn-primary" %>
</div>

<!-- 상품 필터 -->
<div class="bg-zinc-900 rounded-lg p-4 mb-6 border border-zinc-800">
  <%= form_with url: business_products_path, method: :get do |f| %>
    <div class="flex flex-wrap gap-4 items-center">
      <!-- 카테고리 필터 -->
      <div class="flex items-center gap-2">
        <label class="text-sm text-zinc-400">카테고리:</label>
        <% root_categories = @categories.select { |c| c.parent_id.nil? }.sort_by { |c| [c.position || 0, c.name] } %>
        <%= f.select :category_id,
            options_for_select(
              [["모든 카테고리", ""]] + hierarchical_category_options(root_categories),
              params[:category_id]
            ),
            {},
            class: "bg-zinc-800 text-white px-3 py-1.5 rounded-lg border border-zinc-700 focus:outline-none focus:border-blue-500 min-w-[200px]",
            onchange: "this.form.submit()" %>
      </div>
      
      <!-- 상태 필터 -->
      <div class="flex items-center gap-2">
        <label class="text-sm text-zinc-400">상태:</label>
        <%= f.select :status,
            options_for_select([["모든 상태", ""]] + Product.statuses.map { |k,v| [k.humanize, k] }, params[:status]),
            {},
            class: "bg-zinc-800 text-white px-3 py-1.5 rounded-lg border border-zinc-700 focus:outline-none focus:border-blue-500",
            onchange: "this.form.submit()" %>
      </div>
      
      <!-- 재고 필터 -->
      <label class="flex items-center gap-2 cursor-pointer">
        <%= f.check_box :in_stock, 
            { checked: params[:in_stock] == "1", class: "w-4 h-4 text-blue-600 bg-zinc-800 border-zinc-600 rounded focus:ring-blue-500", onchange: "this.form.submit()" }, 
            "1", "0" %>
        <span class="text-sm text-zinc-300">재고 있는 상품만 표시</span>
      </label>
      
      <!-- 필터 초기화 -->
      <% if params[:category_id] || params[:status] || params[:in_stock] %>
        <%= link_to "필터 초기화", business_products_path, 
            class: "text-sm text-zinc-400 hover:text-white ml-auto" %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- 상품 목록 -->
<div class="card">
  <% if @products.any? %>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="text-left border-b border-zinc-800">
            <th class="p-4 font-medium">상품</th>
            <th class="p-4 font-medium">카테고리</th>
            <th class="p-4 font-medium text-right">가격</th>
            <th class="p-4 font-medium text-center">재고</th>
            <th class="p-4 font-medium text-center">상태</th>
            <th class="p-4 font-medium text-center">제안 수</th>
            <th class="p-4"></th>
          </tr>
        </thead>
        <tbody>
          <% @products.each do |product| %>
            <tr class="border-b border-zinc-800/50 hover:bg-zinc-800/30">
              <td class="p-4">
                <div class="flex items-center gap-3">
                  <% if product.images.attached? %>
                    <%= image_tag product.images.first, class: "w-12 h-12 object-cover rounded" %>
                  <% else %>
                    <div class="w-12 h-12 bg-zinc-800 rounded"></div>
                  <% end %>
                  <div>
                    <p class="font-medium"><%= product.name %></p>
                    <p class="text-sm text-zinc-400 truncate max-w-xs"><%= product.description %></p>
                  </div>
                </div>
              </td>
              <td class="p-4">
                <span class="text-sm"><%= product.category&.name || "-" %></span>
              </td>
              <td class="p-4 text-right">
                <%= number_to_currency(product.sale_price) %>
              </td>
              <td class="p-4 text-center">
                <span class="<%= product.stock_quantity > 0 ? '' : 'text-red-400' %>">
                  <%= product.stock_quantity %>
                </span>
              </td>
              <td class="p-4 text-center">
                <span class="badge <%= product.available? ? 'badge-success' : 'badge-secondary' %>">
                  <%= product.status_text %>
                </span>
              </td>
              <td class="p-4 text-center">
                <% request_count = product.purchase_requests.count %>
                <span class="badge <%= request_count > 0 ? 'badge-primary' : 'badge-secondary' %>">
                  <%= request_count %>
                </span>
              </td>
              <td class="p-4">
                <div class="flex gap-2 justify-end">
                  <%= link_to "보기", business_product_path(product), 
                      class: "text-blue-500 hover:text-blue-400" %>
                  <%= link_to "수정", edit_business_product_path(product), 
                      class: "text-zinc-400 hover:text-white" %>
                  <%= button_to "삭제", business_product_path(product), 
                      method: :delete,
                      data: { turbo_confirm: "정말 삭제하시겠습니까?" },
                      class: "text-red-400 hover:text-red-300 cursor-pointer" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    
    <% if @products.total_pages > 1 %>
      <div class="p-4 border-t border-zinc-800">
        <%= paginate @products %>
      </div>
    <% end %>
  <% else %>
    <div class="p-12 text-center">
      <p class="text-zinc-400 mb-4">등록된 상품이 없습니다</p>
      <%= link_to "첫 상품 등록하기", new_business_product_path, class: "btn-primary" %>
    </div>
  <% end %>
</div>