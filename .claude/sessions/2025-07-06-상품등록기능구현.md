# 2025-07-06 - 상품 등록 기능 구현

## 작업 내용
관리자 페이지에서 업체의 상품 등록 기능을 완전히 구현했습니다.

### 주요 기능
1. 계층형 카테고리 시스템
2. 드래그 앤 드롭 이미지 업로드
3. SortableJS를 이용한 이미지 순서 관리
4. WebP 자동 변환 및 다양한 크기 생성
5. 검색 및 필터 기능

## 주요 결정사항

### 1. 카테고리 시스템
- 별도의 Category 모델 생성
- self-referential association으로 계층 구조 구현
- FriendlyId를 사용한 SEO 친화적 URL

### 2. 이미지 처리
- Active Storage의 variant 기능 활용
- thumb (300x300), medium (600x600), large (1200x1200), display (800x800)
- 모든 이미지는 WebP로 자동 변환

### 3. 이미지 순서 관리
- image_positions 필드에 JSON 형태로 순서 저장
- ordered_images 메서드로 순서대로 이미지 반환

## 변경된 파일 목록

### 모델
- `app/models/category.rb` - 새로 생성
- `app/models/product.rb` - 카테고리 관계 및 이미지 관리 기능 추가

### 컨트롤러
- `app/controllers/admin/products_controller.rb` - 필터, 검색, 카테고리 지원

### 뷰
- `app/views/admin/products/_form.html.erb` - 새로 생성
- `app/views/admin/products/new.html.erb` - 간소화
- `app/views/admin/products/edit.html.erb` - 간소화
- `app/views/admin/products/index.html.erb` - 필터/검색 추가

### JavaScript
- `app/javascript/controllers/product_form_controller.js` - 폼 검증 및 할인율 계산
- `app/javascript/controllers/image_upload_controller.js` - 드래그 앤 드롭 및 프리뷰
- `app/javascript/controllers/sortable_controller.js` - 이미지 순서 관리

### 마이그레이션
- `db/migrate/..._create_categories.rb`
- `db/migrate/..._add_category_id_to_products.rb`

### 기타
- `db/seeds.rb` - 카테고리 및 상품 테스트 데이터 추가

## 사용한 코드 패턴

### Stimulus 컨트롤러 패턴
```javascript
export default class extends Controller {
  static targets = ["input", "preview"]
  static values = { maxSize: Number }
  
  connect() {
    // 초기화 코드
  }
}
```

### 이미지 순서 관리 패턴
```ruby
def ordered_images
  return images unless image_positions.present?
  
  all_image_ids = images.map(&:signed_id)
  ordered_ids = image_positions & all_image_ids
  remaining_ids = all_image_ids - ordered_ids
  final_order = ordered_ids + remaining_ids
  
  final_order.map { |signed_id| 
    images.find { |img| img.signed_id == signed_id } 
  }.compact
end
```

## 다음 세션을 위한 참고사항

1. 카테고리 관리 페이지가 아직 구현되지 않음
2. 이미지 업로드 시 AJAX로 실시간 업로드 고려
3. 이미지 크롭 기능 추가 가능
4. 대량 이미지 처리를 위한 백그라운드 작업 고려

## 현재 상태
- 모든 기본 기능 완성
- 테스트 데이터 생성 완료
- 관리자 로그인: admin@endmark.com / password123